generator client {
	provider = "prisma-client-js"
}

datasource db {
	provider = "postgresql"
	url      = env("DATABASE_URL")
}

model credentials {
	user_id     								Int      @id @default(autoincrement())
	username     								String
	password     								String
	is_active    								Boolean  @default(true)
	email        								String?
	phone_number 								String?

	created_at   								DateTime @default(now())
	updated_at   								DateTime @default(now()) @updatedAt

	login_history 								login_history[]
	solana_wallet   							solana_wallet?
}

model login_history {
	login_history_id 							Int       @id @default(autoincrement())
	user_id          							Int
	login_time       							DateTime  @default(now())

	user             							credentials @relation(fields: [user_id], references: [user_id])

	@@index([user_id], name: "login_history__user_id_idx")
}

model solana_wallet {
	solana_wallet_id							Int          @id @default(autoincrement())
	public_key   								String       @db.VarChar(255)
	secret_key   								String       @db.VarChar(255) // Consider storing encrypted!
	user_id      								Int			 @unique

	created_at   								DateTime     @default(now())
	updated_at   								DateTime     @default(now()) @updatedAt

	user        								credentials @relation(fields: [user_id], references: [user_id])

	create_spl_payer_wallet						spl[] @relation("create_spl_payer_wallet")
	create_spl_metadata_payer_wallet			spl[] @relation("create_spl_metadata_payer_wallet")
	spl_creator_wallet							spl[] @relation("spl_creator_wallet")
	spl_mint_payer_wallet						spl_mint[] @relation("spl_mint_payer_wallet")
	token_account_payer_solana_wallet			token_account[] @relation("payer_solana_wallet")
	token_account_parent_solana_wallet			token_account[] @relation("parent_solana_wallet")
	sol_transfer_sender_solana_wallet			sol_transfer[] @relation("sender_solana_wallet")
	sol_transfer_payer_solana_wallet			sol_transfer[] @relation("payer_solana_wallet")
	sol_transfer_recipient_solana_wallet		sol_transfer[] @relation("recipient_solana_wallet")
	spl_purchase_purchaser_solana_wallet		spl_purchase[] @relation("purchaser_solana_wallet")
	spl_purchase_payer_solana_wallet			spl_purchase[] @relation("payer_solana_wallet")
	spl_purchase_recipient_solana_wallet		spl_purchase[] @relation("recipient_solana_wallet")

	@@index([user_id], name: "solana_wallet__user_id_idx")
}

model token_account {
	token_account_id 							Int  @id @default(autoincrement())
	spl_id										Int
	parent_solana_wallet_id						Int
	public_key									String       @db.VarChar(255)
	token_account_creation_fee_sol 				Float
	token_account_creation_fee_usd 				Float
	payer_solana_wallet_id						Int

	created_at    								DateTime  @default(now())
	updated_at    								DateTime  @default(now()) @updatedAt

	spl       									spl @relation(fields: [spl_id], references: [spl_id])
	payer_solana_wallet							solana_wallet @relation(name: "payer_solana_wallet", fields: [payer_solana_wallet_id], references: [solana_wallet_id])
	parent_solana_wallet						solana_wallet @relation(name: "parent_solana_wallet", fields: [parent_solana_wallet_id], references: [solana_wallet_id])

	spl_purchase_purchaser_token_account		spl_purchase[]
	spl_ownership								spl_ownership[]
	spl_mint									spl_mint[]

  	@@index([spl_id], name: "token_account__spl_id_idx")
	@@index([parent_solana_wallet_id], name: "token_account__parent_solana_wallet_id_idx")
	@@index([payer_solana_wallet_id], name: "token_account__payer_solana_wallet_id_idx")
	@@unique([spl_id, parent_solana_wallet_id])
}

enum SPLListingStatus {
	PRELISTING
	LISTED
	SOLDOUT
	REMOVED
}

model spl {
	spl_id           							Int       @id @default(autoincrement())
	meta_data_url  								String
	spl_name      								String  // Name of the SPL
	meta_data_address 							String  // On-chain Address of the SPL metadata
	public_key_address							String 	// The SPL's public key address
	listing_price_per_share_sol					Float
	initial_creator_ownership_percentage		Float
	total_number_of_shares						Int
	creator_wallet_id							Int
	uploaded_image_id							Int		@unique
	uploaded_video_id							Int		@unique

	spl_creation_fee_sol						Float
	spl_creation_fee_usd						Float
	create_spl_payer_solana_wallet_id			Int

	spl_metadata_creation_fee_sol				Float?
	spl_metadata_creation_fee_usd				Float?
	create_spl_metadata_payer_solana_wallet_id	Int?

	spl_listing_status 							SPLListingStatus
	description  								String   // Description of the SPL

	created_at    								DateTime  @default(now())
	updated_at    								DateTime  @default(now()) @updatedAt

	create_spl_payer_wallet						solana_wallet @relation(name: "create_spl_payer_wallet", fields: [create_spl_payer_solana_wallet_id], references: [solana_wallet_id])
	create_spl_metadata_payer_wallet			solana_wallet? @relation(name: "create_spl_metadata_payer_wallet", fields: [create_spl_metadata_payer_solana_wallet_id], references: [solana_wallet_id])
	spl_creator_wallet							solana_wallet @relation(name: "spl_creator_wallet", fields: [creator_wallet_id], references: [solana_wallet_id])
	uploaded_image                              uploaded_image @relation(fields: [uploaded_image_id], references: [uploaded_image_id])
    uploaded_video                              uploaded_video @relation(fields: [uploaded_video_id], references: [uploaded_video_id])

	spl_ownership 								spl_ownership[]
	token_account								token_account[]
	spl_mint									spl_mint[]
	spl_purchase								spl_purchase[]

	@@index([create_spl_payer_solana_wallet_id], name: "spl__create_spl_payer_solana_wallet_id_idx")
	@@index([create_spl_metadata_payer_solana_wallet_id], name: "spl__create_spl_metadata_payer_solana_wallet_id_idx")
	@@index([creator_wallet_id], name: "spl__creator_wallet_id_idx")
	@@index([uploaded_image_id], name: "spl__uploaded_image_id_idx")
}

model spl_mint {
	spl_mint_id									Int @id @default(autoincrement())
	spl_id										Int
  	token_account_id    						Int
	number_of_shares							Int
	spl_mint_fee_sol							Float
	spl_mint_fee_usd							Float
	payer_solana_wallet_id						Int
	transaction_signature						String

	spl         								spl @relation(fields: [spl_id], references: [spl_id])
	token_account       						token_account @relation(fields: [token_account_id], references: [token_account_id])
	spl_mint_payer_wallet						solana_wallet @relation(name: "spl_mint_payer_wallet", fields: [payer_solana_wallet_id], references: [solana_wallet_id])

	spl_purchase_mint							spl_purchase[]

  	@@index([spl_id], name: "spl_mint__spl_id_idx")
  	@@index([token_account_id], name: "spl_mint__token_account_id_idx")
  	@@index([payer_solana_wallet_id], name: "spl_mint__payer_solana_wallet_id_idx")
}

model spl_ownership {
	spl_ownership_id							Int @id @default(autoincrement())
	spl_id 										Int
  	token_account_id    						Int
	number_of_shares							Int

	created_at    								DateTime  @default(now())
	updated_at    								DateTime  @default(now()) @updatedAt

	spl         								spl @relation(fields: [spl_id], references: [spl_id])
	token_account       						token_account @relation(fields: [token_account_id], references: [token_account_id])

  	@@index([spl_id], name: "spl_ownership__spl_id_idx")
  	@@index([token_account_id], name: "spl_ownership__token_account_id_idx")
	@@unique([spl_id, token_account_id])
}

model uploaded_image {
	uploaded_image_id 							Int @id @default(autoincrement())
	image_url									String
	file_name									String
	uuid										String

	created_at    								DateTime  @default(now())
	updated_at    								DateTime  @default(now()) @updatedAt

    spl                                         spl?
}

model uploaded_video {
	uploaded_video_id 							Int @id @default(autoincrement())
	video_url									String
	file_name									String
	uuid										String

	created_at    								DateTime  @default(now())
	updated_at    								DateTime  @default(now()) @updatedAt

    spl                                         spl?
}

model sol_transfer {
	sol_transfer_id								Int @id @default(autoincrement())
	recipient_public_key						String       @db.VarChar(255)
	recipient_solana_wallet_id					Int?
	is_recipient_fortuna_wallet					Boolean
	transaction_signature						String

	sol_transferred								Float
	usd_transferred								Float

	transfer_fee_sol							Float
	transfer_fee_usd							Float

	sender_solana_wallet_id						Int
	payer_solana_wallet_id						Int

	created_at    								DateTime  @default(now())
	updated_at    								DateTime  @default(now()) @updatedAt

	sender_solana_wallet						solana_wallet @relation(name: "sender_solana_wallet", fields: [sender_solana_wallet_id], references: [solana_wallet_id])
	recipient_solana_wallet						solana_wallet? @relation(name: "recipient_solana_wallet", fields: [recipient_solana_wallet_id], references: [solana_wallet_id])
	payer_solana_wallet							solana_wallet @relation(name: "payer_solana_wallet", fields: [payer_solana_wallet_id], references: [solana_wallet_id])

	spl_purchase_sol_transfer					spl_purchase[]

	@@index([sender_solana_wallet_id], name: "sol_transfer__sender_solana_wallet_id_idx")
	@@index([recipient_solana_wallet_id], name: "sol_transfer__recipient_solana_wallet_id_idx")
	@@index([payer_solana_wallet_id], name: "sol_transfer__payer_solana_wallet_id_idx")
}

model spl_purchase {
	spl_purchase_id								Int @id @default(autoincrement())
	spl_id										Int
	sol_paid_per_share							Float
	usd_paid_per_share							Float
	number_shares_purchased						Int
	purchaser_solana_wallet_id					Int
	purchaser_token_account_id					Int
	payer_solana_wallet_id						Int
	recipient_solana_wallet_id					Int // This is the creator

	spl_mint_id									Int		@unique
	sol_transfer_id								Int		@unique

	spl         								spl @relation(fields: [spl_id], references: [spl_id])
	purchaser_solana_wallet						solana_wallet @relation(name: "purchaser_solana_wallet", fields: [purchaser_solana_wallet_id], references: [solana_wallet_id])
	payer_solana_wallet							solana_wallet @relation(name: "payer_solana_wallet", fields: [payer_solana_wallet_id], references: [solana_wallet_id])
	recipient_solana_wallet						solana_wallet @relation(name: "recipient_solana_wallet", fields: [recipient_solana_wallet_id], references: [solana_wallet_id])
    spl_mint                          			spl_mint       @relation(fields: [spl_mint_id], references: [spl_mint_id])
	sol_transfer								sol_transfer   @relation(fields: [sol_transfer_id], references: [sol_transfer_id])
	token_account       						token_account @relation(fields: [purchaser_token_account_id], references: [token_account_id])

	created_at    								DateTime  @default(now())
	updated_at    								DateTime  @default(now()) @updatedAt

	@@index([spl_id], name: "spl_purchase__spl_id_idx")
	@@index([purchaser_solana_wallet_id], name: "spl_purchase__purchaser_solana_wallet_id_idx")
	@@index([payer_solana_wallet_id], name: "spl_purchase__payer_solana_wallet_id_idx")
	@@index([spl_mint_id], name: "spl_purchase__spl_mint_id_idx")
	@@index([sol_transfer_id], name: "spl_purchase__sol_transfer_id_idx")
}
